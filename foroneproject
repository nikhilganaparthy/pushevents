#!/bin/bash

# GitLab API endpoint and access token
GITLAB_API_URL="https://gitlab.example.com/api/v4"
PRIVATE_TOKEN="your_private_token_here"
BRANCH_PREFIX="RELEASE"

# Calculate start date for the last 3 months
start_date=$(date -d "-3 months" +%Y-%m-%dT%H:%M:%SZ)

# Function to fetch push events for all projects and branches starting with the specified prefix
fetch_push_events() {
    project_id=$1
    events_url="${GITLAB_API_URL}/projects/${project_id}/events?after=${start_date}&action=push"
    push_events=$(curl -s --header "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" "${events_url}")
    if [ -z "$push_events" ]; then
        echo "Failed to fetch push events for project ${project_id}. Empty response."
        return
    fi
    branches=$(echo "${push_events}" | jq -r '[.[] | select(.target_branch | startswith($branch_prefix)) | .target_branch] | unique | .[]')
    for branch in $branches; do
        filtered_events=$(echo "${push_events}" | jq --arg branch "$branch" 'select(.target_branch == $branch)')
        if [ -z "$filtered_events" ]; then
            echo "No push events found for branch ${branch} in project ${project_id}."
            continue
        fi
        echo "${filtered_events}"
    done
}

# Function to fetch all projects
fetch_all_projects() {
    projects_url="${GITLAB_API_URL}/projects"
    curl -s --header "PRIVATE-TOKEN: ${PRIVATE_TOKEN}" "${projects_url}"
}

# Fetch all projects
projects=$(fetch_all_projects)

# Iterate through projects and fetch push events for branches starting with the specified prefix
for project in $(echo "${projects}" | jq -r '.[] | @base64'); do
    project_id=$(echo "${project}" | base64 --decode | jq -r '.id')
    project_name=$(echo "${project}" | base64 --decode | jq -r '.name_with_namespace')
    echo "Processing project: ${project_name}"
    fetch_push_events "${project_id}"
done
